<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Tracker</title>
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <img src="LogoJawiUTeM_white-01.png" alt="UTeM Logo" class="logo">
            <div class="header-content">
                <div class="header-title">
                    <i class="fa-solid fa-bus-simple header-icon"></i>
                    <h1>UTeM Bus Tracker</h1>
                </div>
                <p class="header-subtitle">
                    <i class="fa-solid fa-location-dot"></i> Real-Time Campus Transportation Monitoring
                </p>
            </div>
            <div class="header-decoration">
                <div class="decoration-circle"></div>
                <div class="decoration-circle"></div>
                <div class="decoration-circle"></div>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="bus-info">
                    <h2><i class="fa-solid fa-circle-info"></i> Bus Information</h2>
                    <div class="bus-selector">
                        <label><i class="fa-solid fa-bus"></i> Select Bus:</label>
                        <select id="busSelect">
                            <option value="WVJ 4207">WVJ 4207</option>
                            <option value="MKA 8156">MKA 8156</option>
                            <option value="JHR 2943">JHR 2943</option>
                        </select>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <label><i class="fa-solid fa-signal"></i> Status:</label>
                            <span id="status"><span class="status-waiting">Waiting...</span></span>
                        </div>
                        <div class="info-item">
                            <label><i class="fa-solid fa-id-card"></i> Bus ID:</label>
                            <span id="busId">-</span>
                        </div>
                        <div class="info-item">
                            <label><i class="fa-solid fa-user"></i> Driver's Name:</label>
                            <span id="driverName">-</span>
                        </div>
                        <div class="info-item">
                            <label><i class="fa-solid fa-clock"></i> Last Updated:</label>
                            <span id="timestamp">-</span>
                        </div>
                        <div class="info-item">
                            <label><i class="fa-solid fa-location-arrow"></i> Location:</label>
                            <span id="coords">-</span>
                        </div>
                        <div class="info-item">
                            <label><i class="fa-solid fa-map-pin"></i> Place:</label>
                            <span id="locationName">-</span>
                        </div>
                    </div>
                </div>
                <div class="controls">
                    <button id="center-map-btn"><i class="fa-solid fa-crosshairs"></i> Center on Bus</button>
                    <button id="follow-bus-btn"><i class="fa-solid fa-location-pin"></i> Follow Bus</button>
                    <button id="clear-history-btn"><i class="fa-solid fa-trash-can"></i> Clear History</button>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
        <div class="footer">
            <p><i class="fa-solid fa-map-location-dot"></i> Bus Location Tracker | Status: <span id="system-status">Initializing...</span></p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Ayer Keroh, Melaka
        const map = L.map('map').setView([2.2632, 102.2826], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Custom Bus Icon with rotation
        const busIcon = L.divIcon({
            html: '<div class="bus-marker">ðŸšŒ</div>',
            className: 'bus-icon-container',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        const marker = L.marker([2.2632, 102.2826], {icon: busIcon, rotationAngle: 0}).addTo(map);
        const pathLine = L.polyline([], {color: 'var(--primary-color)', weight: 4, opacity: 0.8}).addTo(map);
        
        let firstUpdate = true;
        let pathCoordinates = [];
        let followBus = false;
        let lastPosition = null;
        let currentBusId = 'WVJ 4207';
        let lastLocationUpdate = 0;
        let cachedLocationName = '-';
        const DEFAULT_LAT = 2.2632;
        const DEFAULT_LON = 102.2826;

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';

            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        async function getLocationName(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();

                if (data.address) {
                    const parts = [];
                    if (data.address.house_number) parts.push(data.address.house_number);
                    if (data.address.road) parts.push(data.address.road);
                    if (data.address.neighbourhood) parts.push(data.address.neighbourhood);
                    if (data.address.suburb) parts.push(data.address.suburb);
                    if (data.address.city || data.address.town || data.address.village) {
                        parts.push(data.address.city || data.address.town || data.address.village);
                    }
                    if (data.address.state) parts.push(data.address.state);
                    if (data.address.postcode) parts.push(data.address.postcode);

                    return parts.length > 0 ? parts.join(', ') : data.display_name;
                }
                return 'Unknown Location';
            } catch (error) {
                console.error('Error fetching location name:', error);
                return 'Error fetching location';
            }
        }

        function showAlert(message, type = 'info') {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            document.querySelector('.sidebar').insertBefore(alert, document.querySelector('.sidebar').firstChild);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }

        document.getElementById('center-map-btn').addEventListener('click', () => {
            if (pathCoordinates.length > 0) {
                map.setView(pathCoordinates[pathCoordinates.length - 1], 16);
            }
        });

        document.getElementById('busSelect').addEventListener('change', (e) => {
            currentBusId = e.target.value;
            pathCoordinates = [];
            pathLine.setLatLngs([]);
            lastPosition = null;
            lastLocationUpdate = 0;
            cachedLocationName = '-';
            updateLocation();
        });

        document.getElementById('follow-bus-btn').addEventListener('click', function() {
            followBus = !followBus;
            this.classList.toggle('active');
            this.textContent = followBus ? 'Stop Following' : 'Follow Bus';
        });

        document.getElementById('clear-history-btn').addEventListener('click', () => {
            pathCoordinates = [];
            pathLine.setLatLngs([]);
            showAlert('Location history cleared', 'success');
        });

        function updateLocation() {
            const apiUrl = `/api/bus-location/${currentBusId}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(async data => {
                    const isDefaultPosition = data.latitude === DEFAULT_LAT && data.longitude === DEFAULT_LON;

                    // Determine status from server
                    if (data.status === 'active') {
                        document.getElementById('status').innerHTML = '<span class="status-active">active</span>';
                    } else {
                        document.getElementById('status').innerHTML = '<span class="status-waiting">waiting</span>';
                    }

                    // Always update text info
                    document.getElementById('busId').textContent = data.busId;
                    document.getElementById('driverName').textContent = data.driverName || '-';
                    document.getElementById('timestamp').textContent = formatTimestamp(data.timestamp);
                    document.getElementById('coords').textContent = `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;

                    // Update location name every 1 minute (60000 ms)
                    const now = Date.now();
                    if (!isDefaultPosition && data.timestamp && (now - lastLocationUpdate > 60000 || lastLocationUpdate === 0)) {
                        lastLocationUpdate = now;
                        cachedLocationName = await getLocationName(data.latitude, data.longitude);
                    }
                    document.getElementById('locationName').textContent = isDefaultPosition ? '-' : cachedLocationName;

                    // Always update map marker
                    const newLatLng = [data.latitude, data.longitude];
                    marker.setLatLng(newLatLng);
                    marker.bindPopup(`<b>${data.busId}</b><br>Driver: ${data.driverName || 'N/A'}`);

                    // Calculate and apply rotation if we have a previous position
                    if (lastPosition && !isDefaultPosition && data.timestamp) {
                        const bearing = calculateBearing(lastPosition[0], lastPosition[1], data.latitude, data.longitude);
                        const busMarker = document.querySelector('.bus-marker');
                        if (busMarker) {
                            busMarker.style.transform = `rotate(${bearing}deg)`;
                        }
                    }

                    // Only add valid coordinates to the path (not default position)
                    if (!isDefaultPosition && data.timestamp) {
                        lastPosition = [data.latitude, data.longitude];
                        pathCoordinates.push(newLatLng);
                        if (pathCoordinates.length > 1000) pathCoordinates.shift(); // Keep last 1000 points
                        pathLine.setLatLngs(pathCoordinates);
                        
                        if (followBus) {
                            map.panTo(newLatLng); // Follow the bus
                        }
                    }
                })
                .catch(err => {
                    console.error('Error fetching data:', err);
                    document.getElementById('status').innerHTML = '<span class="status-waiting">waiting</span>';
                    document.getElementById('system-status').textContent = 'Server Error';
                });
        }

        // Poll the server every 2 seconds
        setInterval(updateLocation, 2000);
        updateLocation();
    </script>
</body>
</html>