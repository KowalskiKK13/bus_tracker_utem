<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Tracker</title>
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .header { background: #007bff; color: white; padding: 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 24px; }
        .info-panel { background: white; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .info-card { padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff; }
        .info-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .info-value { font-size: 18px; font-weight: bold; color: #333; margin-top: 5px; }
        #map { height: 600px; width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .status-active { color: #28a745; font-weight: bold; }
        .status-waiting { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöå Real-time Bus Tracker</h1>
            <div id="connection-status" style="font-size: 14px;">‚óè Live System</div>
        </div>
        
        <div class="info-panel">
            <div class="info-card"><div class="info-label">Status</div><div class="info-value" id="status"><span class="status-waiting">Waiting...</span></div></div>
            <div class="info-card"><div class="info-label">Bus ID</div><div class="info-value" id="busId">-</div></div>
            <div class="info-card"><div class="info-label">Signal</div><div class="info-value" id="signal">-</div></div>
            <div class="info-card"><div class="info-label">Last Updated</div><div class="info-value" id="timestamp">-</div></div>
            <div class="info-card"><div class="info-label">Location</div><div class="info-value" id="coords">-</div></div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on 0,0
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Custom Bus Icon
        const busIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        const marker = L.marker([0, 0], {icon: busIcon}).addTo(map);
        const pathLine = L.polyline([], {color: 'blue', weight: 4, opacity: 0.7}).addTo(map);
        
        let firstUpdate = true;
        let pathCoordinates = [];

        function updateLocation() {
            fetch('/api/bus-location')
                .then(response => response.json())
                .then(data => {
                    // Determine status based on coordinates
                    if (data.latitude !== 0 || data.longitude !== 0) {
                        document.getElementById('status').innerHTML = '<span class="status-active">Active Tracking</span>';
                    } else {
                        document.getElementById('status').innerHTML = '<span class="status-waiting">Waiting for Signal...</span>';
                    }
                    
                    // Always update text info
                    document.getElementById('busId').textContent = data.busId;
                    document.getElementById('timestamp').textContent = data.timestamp;
                    document.getElementById('signal').textContent = data.signalStrength + '%';
                    document.getElementById('coords').textContent = `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;

                    // Always update map marker
                    const newLatLng = [data.latitude, data.longitude];
                    marker.setLatLng(newLatLng);
                    marker.bindPopup(`<b>${data.busId}</b><br>Signal: ${data.signalStrength}%`);
                    
                    // Only add valid coordinates to the path
                    if (data.latitude !== 0 || data.longitude !== 0) {
                        pathCoordinates.push(newLatLng);
                        if (pathCoordinates.length > 1000) pathCoordinates.shift(); // Keep last 1000 points
                        pathLine.setLatLngs(pathCoordinates);
                        
                        if (firstUpdate) {
                            map.setView(newLatLng, 16); // Zoom in on first data
                            firstUpdate = false;
                        } else {
                            map.panTo(newLatLng); // Follow the bus
                        }
                    } else {
                        // If we are at 0,0, reset the view
                        if (firstUpdate) {
                            map.setView(newLatLng, 2);
                        }
                    }
                })
                .catch(err => console.error('Error fetching data:', err));
        }

        // Poll the server every 2 seconds
        setInterval(updateLocation, 2000);
        updateLocation();
    </script>
</body>
</html>